<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Racing Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #1a1a1a; color: #e5e5e5; }
        .btn-icon { transition: all 0.2s; display: inline-flex; justify-content: center; align-items: center; width: 32px; height: 32px; border-radius: 4px; cursor: pointer; }
        .btn-icon:hover { transform: translateY(-1px); filter: brightness(1.2); }
        .rank-badge { min-width: 24px; height: 24px; display: inline-flex; align-items: center; justify-content: center; border-radius: 12px; font-weight: bold; font-size: 0.8rem; padding: 0 8px;}
        .rank-1 { background-color: #fbbf24; color: #78350f; } /* 1着: 金 */
        .rank-2 { background-color: #94a3b8; color: #1e293b; } /* 2着: 銀 */
        .rank-3 { background-color: #b45309; color: #fffbeb; } /* 3着: 銅 */
        .rank-other { background-color: #374151; color: #9ca3af; } /* その他 */

        .star-mark { color: #fbbf24; margin-left: 0.35rem; }
        .btn-icon { width: 32px; height: 32px; }


        input:focus { outline: none; border-color: #22c55e; box-shadow: 0 0 0 1px #22c55e; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <header class="mb-6 border-b border-gray-700 pb-3 flex items-center justify-end">
<div class="flex items-center gap-2 w-full sm:w-auto">
                <div class="relative flex-1 sm:w-80">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-xs"></i>
                    <input type="text" id="searchInput"
                        placeholder="検索 (レース名など)"
                        class="w-full bg-gray-800 border border-gray-700 rounded pl-9 pr-3 py-2 text-sm text-gray-200 focus:border-green-500 placeholder-gray-600 transition-colors"
                        oninput="renderList()">
                </div>

                <button id="toggleHorsePickerBtn"
                    class="bg-gray-800 border border-gray-700 rounded-xl px-3 py-2 text-xs text-gray-300 hover:border-gray-600 transition-colors flex items-center gap-1"
                    onclick="toggleHorsePicker()"
                    title="馬を選ぶ" aria-label="馬を選ぶ">
                    <i class="fas fa-horse"></i>
                    <i id="horsePickerChevron" class="fas fa-chevron-down text-[10px] text-gray-500"></i>
                </button>

                <button id="starToggleBtn"
                    class="btn-icon bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm text-gray-200 hover:border-gray-600 transition-colors flex items-center"
                    onclick="toggleStarOnly()"
                    title="お気に入りのみ" aria-label="お気に入りのみ" aria-pressed="false">
                    <i id="starToggleIcon" class="far fa-star"></i>
                </button>


                <div id="selectedHorseBadge" class="text-xs text-gray-400 hidden items-center whitespace-nowrap"><span id="selectedHorseName"></span>
                </div>

                <button id="clearHorseBtn"
                    class="bg-gray-800 border border-gray-700 rounded-xl px-3 py-2 text-xs text-gray-300 hover:border-gray-600 transition-colors hidden whitespace-nowrap"
                    onclick="clearHorseFilter()"><i class="fas fa-xmark"></i></button>
            </div>
        </header>

        <!-- Filter Bar -->
        <!-- Horse Picker (year groups) -->
        <div id="horsePickerWrap" class="mb-6 hidden">
            <div id="horsePicker" class="space-y-5"></div>
        </div>

        <!-- List Section -->
        <div id="raceList" class="space-y-3 pb-12"></div>
        <div id="emptyState" class="text-center py-12 text-gray-600 hidden">
            <p class="text-sm">データが見つかりません</p>
        </div>
    </div>

    <!-- Logic -->
    <script>
        // 外部データ（馬ごとのミニマル構造）を読み込み、従来のrawData形式に展開する
        let rawData = [];
        let horsesData = [];
        let selectedHorseName = null;
        let horsePickerOpen = false;
        let showStarOnly = false; // 初期は一覧性重視で開いておく

        async function loadData() {
            try {
                const res = await fetch('horsesData.json', { cache: 'no-store' });
                if (!res.ok) throw new Error(`Failed to load horsesData.json: ${res.status}`);
                const horses = await res.json();

                horsesData = Array.isArray(horses) ? horses
                    : (horses && Array.isArray(horses.horses) ? horses.horses : []);

                rawData = (horsesData || []).flatMap(h => {
                    const horseName = h.name;
                    const races = Array.isArray(h.races) ? h.races : [];
                    return races.map(r => ({
                        id: r.id ?? r.raceId ?? r.raceID,
                        date: r.date,
                        raceName: r.raceName,
                        horseName,
                        rank: r.rank,
                        ...(r.star === true ? { star: true } : {})
                    }));
                }).filter(r => r.id && r.date && r.raceName && r.horseName);

                init();
            } catch (e) {
                console.error(e);
                const emptyEl = document.getElementById('emptyState');
                if (emptyEl) {
                    emptyEl.classList.remove('hidden');
                    emptyEl.innerHTML = '<p class="text-sm">データの読み込みに失敗しました</p><p class="text-xs mt-2 text-gray-500">※ file:// で開いとる場合は fetch が失敗することがあるけぇ、ローカルサーバ（例: VS Code の Live Server / python -m http.server）で開いてみてつかぁさい。</p>';
                }
            }
        }

        loadData();

        let races = [];

        const PLACE_MAP = {
            '01': '札幌', '02': '函館', '03': '福島', '04': '新潟', '05': '東京',
            '06': '中山', '07': '中京', '08': '京都', '09': '阪神', '10': '小倉'
        };

        function init() {
            races = rawData.map(item => ({ ...item, parsed: parseNetkeibaID(item.id) }));

            buildHorsePicker();
            updateHorsePickerUI();
            updateSelectedHorseUI();
            updateStarToggleUI();

            renderList();
        }

        function getBirthYearFromHorse(h) {
            const id = (h && typeof h.horseId === 'string') ? h.horseId : '';
            if (id.length < 4) return null;
            const y = parseInt(id.slice(0, 4), 10);
            return Number.isFinite(y) ? y : null;
        }

        function toggleHorsePicker() {
            horsePickerOpen = !horsePickerOpen;
            updateHorsePickerUI();
        }

        function closeHorsePicker() {
            horsePickerOpen = false;
            updateHorsePickerUI();
        }

        function updateHorsePickerUI() {
            const wrap = document.getElementById('horsePickerWrap');
            const chev = document.getElementById('horsePickerChevron');
            if (!wrap || !chev) return;
            if (horsePickerOpen) {
                wrap.classList.remove('hidden');
                chev.classList.remove('fa-chevron-down');
                chev.classList.add('fa-chevron-up');
            } else {
                wrap.classList.add('hidden');
                chev.classList.remove('fa-chevron-up');
                chev.classList.add('fa-chevron-down');
            }
        }

        function clearHorseFilter() {
            selectedHorseName = null;
            updateSelectedHorseUI();
            renderList();
        }

        function setHorseFilterByName(name) {
            selectedHorseName = name || null;
            updateSelectedHorseUI();
            // 選んだら折りたたむ
            closeHorsePicker();
            // レース一覧先頭へ（スマホの体験が良い）
            window.scrollTo({ top: 0, behavior: 'smooth' });
            renderList();
        }

        
        function toggleStarOnly() {
            showStarOnly = !showStarOnly;
            updateStarToggleUI();
            renderList();
        }

        function updateStarToggleUI() {
            const btn = document.getElementById('starToggleBtn');
            const icon = document.getElementById('starToggleIcon');
            if (!btn || !icon) return;

            if (showStarOnly) {
                btn.setAttribute('aria-pressed', 'true');
                icon.classList.remove('far');
                icon.classList.add('fas');
                icon.classList.add('text-yellow-400');
            } else {
                btn.setAttribute('aria-pressed', 'false');
                icon.classList.remove('fas');
                icon.classList.add('far');
                icon.classList.remove('text-yellow-400');
            }
        }

function updateSelectedHorseUI() {
            const badge = document.getElementById('selectedHorseBadge');
            const nameEl = document.getElementById('selectedHorseName');
            const clearBtn = document.getElementById('clearHorseBtn');
            if (!badge || !nameEl || !clearBtn) return;

            if (selectedHorseName) {
                badge.classList.remove('hidden');
                badge.classList.add('inline-flex');
                clearBtn.classList.remove('hidden');
                nameEl.textContent = selectedHorseName;
            } else {
                badge.classList.add('hidden');
                badge.classList.remove('inline-flex');
                clearBtn.classList.add('hidden');
                nameEl.textContent = '';
            }
        }

        function buildHorsePicker() {
            const pickerEl = document.getElementById('horsePicker');
            if (!pickerEl) return;

            const groups = new Map(); // year -> horses[]
            for (const h of (horsesData || [])) {
                const y = getBirthYearFromHorse(h);
                const key = (y === null) ? '不明' : String(y);
                if (!groups.has(key)) groups.set(key, []);
                groups.get(key).push(h);
            }

            const years = Array.from(groups.keys()).sort((a, b) => {
                if (a === '不明') return 1;
                if (b === '不明') return -1;
                return parseInt(b, 10) - parseInt(a, 10); // 若い年が上
            });

            pickerEl.innerHTML = '';

            for (const y of years) {
                const hs = groups.get(y) || [];
                // 同年内は名前順（好み順を固定したくなったらここを差し替え）
                hs.sort((a, b) => (a.name || '').localeCompare(b.name || '', 'ja'));

                const section = document.createElement('section');
                section.className = 'space-y-2';

                const title = document.createElement('div');
                title.className = 'flex items-baseline justify-between';
                title.innerHTML = `
                    <div class="text-sm font-bold text-gray-300">
                        ${escapeHtml(y)}<span class="text-xs font-normal text-gray-500 ml-1">(${hs.length})</span>
                    </div>
                `;

                const grid = document.createElement('div');
                // スマホは2列、広いと3列（4列は使わない）
                grid.className = 'grid grid-cols-2 sm:grid-cols-3 gap-2';

                for (const h of hs) {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'bg-gray-800 border border-gray-700 rounded-xl px-3 py-2 text-sm text-gray-200 hover:border-gray-600 transition-colors text-left min-h-[44px] truncate';
                    btn.textContent = h.name || '';
                    btn.onclick = () => setHorseFilterByName(h.name || '');
                    grid.appendChild(btn);
                }

                section.appendChild(title);
                section.appendChild(grid);
                pickerEl.appendChild(section);
            }
        }

        function getNetkeibaRaceUrl(raceId) {
            return `https://db.netkeiba.com/race/${raceId}/`;
        }

        function parseNetkeibaID(fullId) {
            // JRAの12桁（数字のみ）以外は「海外/不明ID」として扱う（place/race番号表示やviewerリンク生成をしない）
            if (!fullId) return { isForeign: true };
            if (/^\d{12}$/.test(fullId)) {
                return {
                    isForeign: false,
                    year: fullId.substring(0, 4),
                    place: fullId.substring(4, 6),
                    kai: fullId.substring(6, 8),
                    day: fullId.substring(8, 10),
                    race: fullId.substring(10, 12)
                };
            }
            return { isForeign: true, rawId: String(fullId) };
        }

        function generateViewerLinks(raceData, dateStr) {
            if (!raceData || raceData.isForeign) return null;

            const dateClean = dateStr.replace(/-/g, '');
            const yy = raceData.year.substring(2, 4);
            const p = parseInt(raceData.place).toString();
            const kNum = parseInt(raceData.kai);
            const k = kNum >= 10 ? kNum.toString(16) : kNum.toString();
            const dNum = parseInt(raceData.day);
            const d = dNum >= 10 ? dNum.toString(16) : dNum.toString();
            const rNum = parseInt(raceData.race);
            let rCode = rNum >= 10 ? rNum.toString(16) : rNum.toString();
            const viewerId = `${yy}${p}${k}${d}${rCode}`;
            const baseUrl = "https://regist.prc.jp/api/windowopen.aspx?target=race";
            const yearPath = raceData.year;

            return {
                raceOnly: `${baseUrl}/${yearPath}/${dateClean}/${viewerId}&quality=5&view=0`,
                raceOnlyLow: `${baseUrl}/${yearPath}/${dateClean}/${viewerId}&quality=2&view=0`,
                raceTime: `${baseUrl}/${yearPath}/${dateClean}/${viewerId}_t&quality=4`,
                paddock: `${baseUrl}/${yearPath}/${dateClean}/${viewerId}_p&quality=4`,
                patrol: `${baseUrl}/${yearPath}/${dateClean}/${viewerId}&quality=5&view=1`,
                multi: `${baseUrl}/${yearPath}/${dateClean}/${viewerId}_m&quality=4`
            };
        }

        function normalizeRank(rank) {
            if (typeof rank === 'number' && Number.isFinite(rank)) {
                return { kind: 'num', n: rank };
            }
            if (typeof rank === 'string') {
                const t = rank.trim();
                if (/^\d+$/.test(t)) {
                    return { kind: 'num', n: parseInt(t, 10) };
                }
                if (t.length > 0) {
                    return { kind: 'text', text: t };
                }
            }
            return { kind: 'none' };
        }

        function getRankClass(rankNum) {
            if (rankNum === 1) return 'rank-1';
            if (rankNum === 2) return 'rank-2';
            if (rankNum === 3) return 'rank-3';
            return 'rank-other';
        }

        function escapeHtml(str) {
            return String(str)
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }

        function renderList() {
            const listEl = document.getElementById('raceList');
            const emptyEl = document.getElementById('emptyState');
            const searchVal = document.getElementById('searchInput').value.toLowerCase().trim();
            const showHorseLabelInRows = (selectedHorseName === null);
listEl.innerHTML = '';

            let filtered = races.filter(race => {
                // 検索フィルター
                let matchesSearch = true;
                if (searchVal) {
                    const placeName = race.parsed && !race.parsed.isForeign ? PLACE_MAP[race.parsed.place] : '';
                    const target = `${race.date} ${race.raceName || ''} ${race.horseName || ''} ${placeName || ''}`.toLowerCase();
                    const keywords = searchVal.split(/\s+/);
                    matchesSearch = keywords.every(k => target.includes(k));
                }

                // 馬名フィルター
                let matchesHorse = true;
                if (selectedHorseName) {
                    matchesHorse = (race.horseName === selectedHorseName);
                }

                // お気に入りフィルター
                let matchesStar = true;
                if (showStarOnly) {
                    matchesStar = (race.star === true);
                }

                return matchesSearch && matchesHorse && matchesStar;
            });

            filtered.sort((a, b) => b.date.localeCompare(a.date));

            if (filtered.length === 0) {
                emptyEl.classList.remove('hidden');
                return;
            } else {
                emptyEl.classList.add('hidden');
            }

            filtered.forEach(race => {
                const links = generateViewerLinks(race.parsed, race.date);
                const netkeibaUrl = (/^\d{12}$/.test(String(race.id))) ? getNetkeibaRaceUrl(String(race.id)) : null;
                const iconNetkeiba = netkeibaUrl ? `
                    <a href="${netkeibaUrl}" target="_blank" rel="noopener noreferrer" class="btn-icon bg-gray-700/40 hover:bg-gray-700" title="netkeiba" aria-label="netkeiba">
                        <i class=\"fas fa-up-right-from-square\"></i>
                    </a>
                ` : '';
                const isForeign = race.parsed && race.parsed.isForeign;
                const placeName = (!isForeign && race.parsed) ? (PLACE_MAP[race.parsed.place] || '') : '<span class="text-xs border border-gray-600 px-1 rounded ml-1">海外</span>';
                const rNum = (!isForeign && race.parsed) ? (parseInt(race.parsed.race) + 'R') : '';

                const horseChipHtml = showHorseLabelInRows
                    ? `<button type="button" class="horse-chip text-xs px-2 py-0.5 rounded border border-gray-600 ml-1 text-gray-200 hover:border-green-500 hover:text-green-300 transition-colors"
                        data-horse="${escapeHtml(race.horseName)}">${escapeHtml(race.horseName)}</button>`
                    : '';

                const row = document.createElement('div');
                row.className = "bg-gray-800 rounded-lg p-4 flex flex-col sm:flex-row items-start sm:items-center justify-between hover:bg-gray-750 border-l-4 border-transparent hover:border-green-500 transition-colors shadow-sm gap-3";

                let linksHtml = '';
                if (links) {
                    linksHtml = `
                        <div class="flex items-center gap-1 mt-2 sm:mt-0">
                            <a href="${links.raceOnly}" target="_blank" title="レース映像(高画質)" class="btn-icon bg-blue-600 text-white hover:bg-blue-500">
                                <i class="fas fa-play text-xs"></i>
                            </a>
                            <a href="${links.raceOnlyLow}" target="_blank" title="レース映像(低画質/予備)" class="btn-icon bg-blue-900 text-blue-300 hover:bg-blue-800 w-6">
                                <span class="text-[10px] font-bold">SD</span>
                            </a>

                            <a href="${links.raceTime}" target="_blank" title="タイム付" class="btn-icon bg-indigo-900 text-indigo-200 hover:bg-indigo-700 hover:text-white">
                                <i class="fas fa-stopwatch text-xs"></i>
                            </a>
                            <a href="${links.paddock}" target="_blank" title="パドック" class="btn-icon bg-green-900 text-green-200 hover:bg-green-700 hover:text-white">
                                <i class="fas fa-horse text-xs"></i>
                            </a>
                            <a href="${links.multi}" target="_blank" title="マルチカメラ" class="btn-icon bg-purple-900 text-purple-200 hover:bg-purple-700 hover:text-white">
                                <i class="fas fa-border-all text-xs"></i>
                            </a>
                            <a href="${links.patrol}" target="_blank" title="パトロール" class="btn-icon bg-gray-700 text-gray-300 hover:bg-gray-600 hover:text-white">
                                <i class="fas fa-video text-xs"></i>
                            </a>
                        
                            <a href="https://db.netkeiba.com/race/${race.id}/" target="_blank" title="netkeiba" class="btn-icon bg-amber-900 text-amber-200 hover:bg-amber-700 hover:text-white">
                                <i class="fas fa-arrow-up-right-from-square text-xs"></i>
                            </a>

                        </div>
                    `;
                } else {
                    linksHtml = `
                        <div class="flex items-center gap-2 mt-2 sm:mt-0 opacity-50 select-none">
                            <span class="text-xs text-gray-500"><i class="fas fa-ban mr-1"></i>映像なし</span>
                        </div>
                    `;
                }

                row.innerHTML = `
                    <div class="flex-1 w-full sm:w-auto">
                        <div class="flex items-center gap-2 mb-1 flex-wrap">
                            <span class="text-gray-400 text-xs font-mono">${race.date.replace(/-/g, '/')}</span>
                            <span class="text-gray-500 text-xs font-bold">${placeName}${rNum}</span>
                            ${horseChipHtml}
                        </div>
                        <div class="flex items-center gap-3">
                            ${(() => {
                                const rk = normalizeRank(race.rank);
                                if (rk.kind === 'num') {
                                    return `<div class="${getRankClass(rk.n)} rank-badge shadow-sm">
                                        ${rk.n}<span class="text-[0.6rem] ml-0.5 font-normal">着</span>
                                    </div>`;
                                }
                                if (rk.kind === 'text') {
                                    return `<div class="rank-other rank-badge shadow-sm">
                                        ${escapeHtml(rk.text)}
                                    </div>`;
                                }
                                return '';
                            })()}
                            <span class="text-white font-bold text-lg leading-tight">${escapeHtml(race.raceName)}${(race.star === true) ? ' <i class="fas fa-star text-yellow-400 ml-1"></i>' : ''}</span>
                        </div>
                    </div>
                    ${linksHtml}
                `;
                const chip = row.querySelector('.horse-chip');
                if (chip) {
                    chip.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        setHorseFilterByName(race.horseName);
                    });
                }
                listEl.appendChild(row);
            });
        }
    </script>
</body>
</html>
